<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Hello, world!</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tufte-css/1.7.2/tufte.min.css" />
    
    <style>
      nav a:first-child {
        font-variant: small-caps;
        font-size: 1.4em; 
      }

      nav a:not(:first-child) {
        margin-left: 1em;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="/">Writings & Things</a>
      <a href="/search.html">Search</a>
      <a href="/sitemap.xml">Sitemap</a>
    </nav>
    <span class="newthought"></span>
    
    <div class="container">
      <script id="entry" type="text/x-handlebars">
        <article>
          <a name="/{{slug}}"></a>
          <h1><a href="/#/{{slug}}">{{entryTitle}}</a></h1>

          {{#if title}}
            <p class="subtitle">
              {{formatDate ts 'ddd MMM D YYYY'}}
            </p>
          {{/if}}

          {{#if tags}}
            Tags:
            {{#each tags}}
              {{this}}
            {{/each}}
          {{/if}}  

          <section data-entry-contents="{{path}}"/>
        </article>
      </script>
    </div>


    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.2/handlebars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.8.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>

    <script>
      Handlebars.registerHelper("entryTitle", function() {
        return this.title || moment(this.ts).format('MMMM Do, YYYY');
      });

      Handlebars.registerHelper("sidenote", function(val) {
        var id = '_' + Math.random().toString(36).substr(2, 9);
        return new Handlebars.SafeString('<label for="' + id + '" class="margin-toggle sidenote-number"></label><input type="checkbox" id="' + id + '" class="margin-toggle"/><span class="sidenote">' + val + '</span>');
      });

      Handlebars.registerHelper("formatDate", function(date, format) {
        return moment(date).format(format);
      });

      var template = Handlebars.compile($('#entry').text());
      $.when($.get('entries.json')).then((entries) => {
        var now = Date.now();
        entries = entries.filter(e => now >= e.ts); // filter future entries

        var hash = window.location.hash.substr(2);
        if (hash) {
          entries = hash.split(',').map(s => entries.find(e => e.slug === s));
          //entries = entries.filter(e => .includes(e.slug));
        }

        for (entry of entries) {
          $('.container').append(template(entry));
        }

        $('[data-entry-contents]').each((i, e) => {
          var ele = $(e);
          $.get(ele.data('entry-contents')).then(contents => {
            ele.append(marked(Handlebars.compile(contents)())); // could pass some things in here?
          });
        });
      });

    </script>
  </body>
</html>